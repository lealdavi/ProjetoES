<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Preencher Avaliação Física</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">Minha Avaliação Física</h2>
            <a href="http://localhost:8080/usuario" class="text-blue-600 hover:underline">Voltar</a>
        </div>

        <form id="avalForm" class="space-y-6">
            <!-- ID vindo do Backend -->
            <div>
                <label class="block text-sm font-medium text-gray-700">ID do Usuário</label>
                <input type="number" id="id_usuario" value="{{ id_usuario }}" readonly 
                       class="mt-1 block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm p-2">
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Idade</label>
                    <input type="number" id="idade" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Peso (kg)</label>
                    <input type="number" id="peso" step="0.1" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Altura (m)</label>
                    <input type="number" id="altura" step="0.01" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                </div>
            </div>

            <fieldset class="border p-4 rounded-md">
                <legend class="text-sm font-semibold text-gray-700 px-2">Histórico de Doenças</legend>
                <div class="space-y-2 mt-2">
                    <label class="inline-flex items-center"><input type="checkbox" name="doenca" value="DIABETES" class="mr-2"> Diabetes</label><br>
                    <label class="inline-flex items-center"><input type="checkbox" name="doenca" value="HIPERTENSAO" class="mr-2"> Hipertensão</label><br>
                    <label class="inline-flex items-center"><input type="checkbox" name="doenca" value="HERNIA" class="mr-2"> Hérnia</label>
                </div>
                <div class="mt-3">
                    <label class="block text-sm">Outra:</label>
                    <input type="text" id="outra_doenca" class="w-full border border-gray-300 rounded-md p-2">
                </div>
            </fieldset>

            <div>
                <label class="block text-sm font-medium text-gray-700">Limitações Físicas</label>
                <input type="text" id="limitacoes" placeholder="Ex: Dor no joelho..." class="mt-1 block w-full border border-gray-300 rounded-md p-2">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nível</label>
                    <select id="nivel" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                        <option value="INICIANTE">Iniciante</option>
                        <option value="INTERMEDIARIO">Intermediário</option>
                        <option value="AVANCADO">Avançado</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Frequência (dias/semana)</label>
                    <input type="number" id="frequencia" min="1" max="7" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                </div>
            </div>

            <button type="button" onclick="enviarDados()" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition">
                SALVAR AVALIAÇÃO
            </button>
        </form>

        <div id="res" class="mt-6 hidden p-4 rounded-md text-center"></div>
    </div>

    <script>
        async function enviarDados() {
            const doencasChecks = [];
            document.querySelectorAll('input[name="doenca"]:checked').forEach(el => doencasChecks.push(el.value));

            const userId = document.getElementById("id_usuario").value;
            if(!userId) { alert("ID do usuário inválido"); return; }

            const payload = {
                id_usuario: parseInt(userId),
                idade: parseInt(document.getElementById("idade").value),
                peso: parseFloat(document.getElementById("peso").value),
                altura: parseFloat(document.getElementById("altura").value),
                doencas_selecionadas: doencasChecks,
                outra_doenca: document.getElementById("outra_doenca").value,
                limitacoes: document.getElementById("limitacoes").value,
                nivel: document.getElementById("nivel").value,
                frequencia: parseInt(document.getElementById("frequencia").value)
            };

            const divRes = document.getElementById("res");
            
            try {
                // Fetch para a própria rota /avaliacao deste serviço
                const req = await fetch("/avaliacao", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                
                const data = await req.json();
                divRes.style.display = "block";
                divRes.classList.remove("hidden");

                if(req.ok) {
                    divRes.className = "mt-6 p-4 rounded-md bg-green-100 text-green-800 border border-green-200";
                    divRes.innerHTML = `<strong>Sucesso!</strong> Avaliação salva.<br>IMC: ${data.imc_calculado}`;
                } else {
                    divRes.className = "mt-6 p-4 rounded-md bg-red-100 text-red-800 border border-red-200";
                    divRes.innerHTML = `Erro: ${data.error || "Erro desconhecido"}`;
                }
            } catch (e) {
                alert("Erro de conexão.");
            }
        }
    </script>
</body>
</html>/html>
